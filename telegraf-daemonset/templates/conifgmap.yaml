apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "fullname" . }}
  labels:
    app: {{ template "fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
data:
  telegraf.conf: |+
    {{- if .Values.config.global_tags }}
    [global_tags]
      {{- range $key, $val := .Values.config.global_tags}}
      {{ $key }} = {{ $val | quote }}
      {{- end }}
    {{- end }}
    [agent]
    {{- range $key, $value := .Values.config.agent -}}
      {{- $tp := typeOf $value }}
      {{- if eq $tp "string"}}
      {{ $key }} = {{ $value | quote }}
      {{- end }}
      {{- if eq $tp "float"}}
      {{ $key }} = {{ $value | int64 }}
      {{- end }}
      {{- if eq $tp "int"}}
      {{ $key }} = {{ $value | int64 }}
      {{- end }}
      {{- if eq $tp "bool"}}
      {{ $key }} = {{ $value }}
      {{- end }}
    {{- end }}
    {{ range $output, $config := .Values.config.outputs -}}
    [[outputs.{{- $output }}]]
      {{- if $config }}
        {{- range $key, $value := $config }}
          {{- $tp := typeOf $value }}
          {{- if eq $tp "string"}}
      {{ $key }} = {{ $value | quote }}
          {{- end }}
          {{- if eq $tp "float"}}
      {{ $key }} = {{ $value | int64 }}
          {{- end }}
          {{- if eq $tp "int"}}
      {{ $key }} = {{ $value | int64 }}
          {{- end }}
          {{- if eq $tp "bool"}}
      {{ $key }} = {{ $value }}
          {{- end }}
          {{- if eq $tp "[]interface {}" }}
      {{ $key }} = [
              {{- $numOut := len $value }}
              {{- $numOut := sub $numOut 1 }}
              {{- range $b, $val := $value }}
                {{- $i := int64 $b }}
                {{- if eq $i $numOut }}
        {{ $val | quote }}
                {{- else }}
        {{ $val | quote }},
                {{- end }}
              {{- end }}
      ]
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{ range $input, $config := .Values.config.inputs -}}
    [[inputs.{{- $input }}]]
      {{- if $config }}
        {{- range $key, $value := $config }}
          {{- $tp := typeOf $value }}
          {{- if eq $tp "string"}}
      {{ $key }} = {{ $value | quote }}
          {{- end }}
          {{- if eq $tp "float"}}
      {{ $key }} = {{ $value | int64 }}
          {{- end }}
          {{- if eq $tp "int"}}
      {{ $key }} = {{ $value | int64 }}
          {{- end }}
          {{- if eq $tp "bool"}}
      {{ $key }} = {{ $value }}
          {{- end }}
          {{- if eq $tp "[]interface {}" }}
      {{ $key }} = [
              {{- $numOut := len $value }}
              {{- $numOut := sub $numOut 1 }}
              {{- range $b, $val := $value }}
                {{- $i := int64 $b }}
                {{- if eq $i $numOut }}
        {{ $val | quote }}
                {{- else }}
        {{ $val | quote }},
                {{- end }}
              {{- end }}
      ]
          {{- end }}
        {{- end }}
      {{- end }}
    {{ end }}
  